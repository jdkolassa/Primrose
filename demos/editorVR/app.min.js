function wipeScene(){for(var e=subScene.children.length-1;e>=0;--e)subScene.remove(subScene.children[e])}function updateScript(){var e=editor.value;e!==lastScript&&(env.transition(function(){scriptUpdateTimeout=null,lastScript=e,e.indexOf("function update")>=0&&e.indexOf("return update")<0&&(e+="\nreturn update;"),console.log("----- loading new script -----"),scriptAnimate=null;try{var t=new Function("scene",e);wipeScene(),scriptAnimate=t.call(env,subScene),scriptAnimate&&scriptAnimate(0),console.log("----- script loaded -----"),scriptAnimate?env.quality===Primrose.Constants.Quality.NONE&&(env.quality=Primrose.Constants.Quality.MEDIUM):console.log("----- No update script provided -----")}catch(n){t=null,console.error(n),console.error(e)}},null,first),first=!1)}function getSourceCode(e){var t=testDemo.toString(),n=e&&t||getSetting("code",t);if(n===t){var i=n.replace("\r\n","\n").split("\n");i.pop(),i.shift();var o=i[0].match(/^\s+/)[0].length;console.log(o);for(var r=0;r<i.length;++r)i[r]=i[r].substring(o);n=i.join("\n")}return n.trim()}Object.assign(window,Primrose.Random);var SCRIPT_UPDATE_TIME=1e3,GRASS="../shared_assets/images/grass.png",ROCK="../shared_assets/images/rock.png",SAND="../shared_assets/images/sand.png",WATER="../shared_assets/images/water.png",DECK="../shared_assets/images/deck.png",env=new Primrose.BrowserEnvironment({skyTexture:"../shared_assets/images/bg2.jpg",groundTexture:GRASS,font:"../shared_assets/fonts/helvetiker_regular.typeface.json",fullScreenButtonContainer:"#fullScreenButtonContainer"}),subScene=hub(),editor=null,modA=isMacOS?"metaKey":"ctrlKey",modB=isMacOS?"altKey":"shiftKey",cmdA=isMacOS?"CMD":"CTRL",cmdB=isMacOS?"OPT":"SHIFT",cmdPre=cmdA+"+"+cmdB,scriptUpdateTimeout,lastScript=null,scriptAnimate=null;env.addEventListener("ready",function(){env.scene.add(subScene);var e=isMobile?512:1024,t=isMobile?10:20;editor=new Primrose.Controls.TextBox({id:"Editor",width:e,height:e,geometry:shell(1.5,25,25),fontSize:t,tokenizer:Primrose.Text.Grammars.JavaScript,value:getSourceCode(isInIFrame)}).addTo(env.vicinity).at(0,env.options.avatarHeight,0),console.log("INSTRUCTIONS:"),console.log(" - "+cmdPre+"+E to show/hide editor"),console.log(" - "+cmdPre+"+X to reload original demo code"),console.log(" - Z to reset position/sensor"),console.log(),Preloader.hide()}),env.addEventListener("update",function(){if(scriptUpdateTimeout||(scriptUpdateTimeout=setTimeout(updateScript,SCRIPT_UPDATE_TIME)),scriptAnimate)if(env.quality===Primrose.Constants.Quality.NONE)scriptAnimate=null,wipeScene();else try{scriptAnimate.call(env,env.deltaTime)}catch(e){scriptAnimate=null,console.error(e)}}),env.addEventListener("keydown",function(e){e[modA]&&e[modB]&&(e.keyCode===Primrose.Keys.E?editor.visible=!editor.visible:e.keyCode===Primrose.Keys.X&&(editor.value=getSourceCode(!0))),scriptUpdateTimeout&&(clearTimeout(scriptUpdateTimeout),scriptUpdateTimeout=null)}),window.addEventListener("beforeunload",function(e){return e.returnValue="Are you sure you want to leave?"},!1),window.addEventListener("unload",function(){if(console.log("unloading, going to try to save file?",!!editor),editor){var e=editor.value;e.length>0&&setSetting("code",e)}});var first=!0;