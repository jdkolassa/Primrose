function fixAudio(){for(var e=document.querySelectorAll("audio"),o=0;o<audio.length;++o)e[o].play();e.length>0&&(env.options.fullScreenElement.removeEventListener("mousedown",fixAudio),env.options.fullScreenElement.removeEventListener("touchstart",fixAudio),env.options.fullScreenElement.removeEventListener("keydown",fixAudio))}function updateObj(e,o){e.velocity&&(TEMP.copy(e.velocity).multiplyScalar(o).add(e.position),e.position.copy(TEMP),e.sound&&e.sound.at(e.position.x,e.position.y,e.position.z,e.velocity.x,e.velocity.y,e.velocity.z))}function shoot(e){var o=0;for(o=0;o<shots.length&&shots[o].visible;++o);var n=null;o>=shots.length?(n=box(.01,.01,.05).colored(16777087,{unshaded:!0}).named("shot"+shots.length),n.velocity=v3(),shots.push(n),env.scene.add(n)):n=shots[o],n.position.copy(e.pointer.picker.ray.origin),n.position.y-=.5,n.position.x+=.5*(o%2*2-1),n.velocity.copy(e.pointer.picker.ray.direction).multiplyScalar(10),n.age=3,n.lookAt(TEMP.copy(n.position).add(n.velocity)),n.visible=!0,n.sound=env.music.getOsc(shotSoundType).on(30,.25).at(n.position.x,n.position.y,n.position.z,n.velocity.x,n.velocity.y,n.velocity.z).on(5,.25,.5,!0).off(.51)}for(var cube=range(6,function(e){return"../shared_assets/images/space"+e+".jpg"}),env=new Primrose.BrowserEnvironment({font:"../shared_assets/fonts/helvetiker_regular.typeface.json",skyTexture:cube,backgroundColor:0,drawDistance:100,gazeLength:.25,showHeadPointer:isMobile,ambientSound:"../shared_assets/audio/space.ogg",fullScreenButtonContainer:"#fullScreenButtonContainer",progress:Preloader.thunk}),blocks=[],shots=[],TEMP=v3(),baseVectorSize=3,asteroidColor=8355711,shotSoundType="sawtooth",asteroid=[box(baseVectorSize).colored(asteroidColor).named("asteroid1"),[],[]],sounds=null,nextSound=0,explosion=null,checker=raycaster(),s=1;s<=2;++s)for(var x=0;x<2;++x)for(var y=0;y<2;++y)for(var z=0;z<2;++z){var sz=.5*baseVectorSize/s,b=box(sz).colored(asteroidColor).named("asteroid"+s+"_"+x+"_"+y+"_"+z);b.position.set(sz*(x-1),sz*(y-1),sz*(z-1)),asteroid[s].push(b)}env.addEventListener("ready",function(){isMobile&&(env.options.fullScreenElement.addEventListener("mousedown",fixAudio),env.options.fullScreenElement.addEventListener("touchstart",fixAudio),env.options.fullScreenElement.addEventListener("keydown",fixAudio)),env.insertFullScreenButtons("body"),Promise.all(range(10,function(){return new Primrose.Audio.Sound(env.audio,"../shared_assets/audio/exp.ogg").ready})).then(function(e){sounds=e,range(10,function(){var e=asteroid[0].clone();e.nextSize=1,e.position.copy(Primrose.Random.vector(-15,15)),e.velocity=Primrose.Random.vector(-1,1),blocks.push(e),env.scene.add(e)}),Preloader.hide()})}),env.addEventListener("update",function(){const e=env.deltaTime;for(var o=0;o<blocks.length;++o){var n=blocks[o];TEMP.copy(env.head.position).sub(n.position);var t=TEMP.lengthSq();n.velocity.add(TEMP.normalize().multiplyScalar(.5/t)),updateObj(n,e)}for(var o=0;o<shots.length;++o){var i=shots[o],s=i.velocity.lengthSq()*e;if(updateObj(i,e),i.age-=e,i.age<=0&&(i.visible=!1),i.visible){checker.set(i.position,i.velocity),checker.ray.direction.normalize();for(var r=checker.intersectObjects(blocks),a=0;a<r.length;++a){var l=r[a];if(l.distance*l.distance<s){i.age=0,i.visible=!1;var n=l.object,d=blocks.indexOf(n);if(sounds){var c=sounds[nextSound];nextSound=(nextSound+1)%sounds.length,c.play().at(n.position.x,n.position.y,n.position.z,n.velocity.x,n.velocity.y,n.velocity.z)}if(env.scene.remove(n),n.nextSize<asteroid.length)for(var v=asteroid[n.nextSize],u=0;u<v.length;++u){var p=v[u].clone();p.velocity=Primrose.Random.vector(-1,1).add(n.velocity),p.position.add(n.position),p.nextSize=n.nextSize+1,0===u?blocks[d]=p:blocks.push(p),env.scene.add(p)}else blocks.splice(d,1);break}}}}}),env.sky.addEventListener("select",shoot);